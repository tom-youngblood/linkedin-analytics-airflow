name: Daily LinkedIn to HubSpot Sync

on:
  schedule:
    # Run once daily at 9 AM UTC on weekdays
    - cron: '0 9 * * 1-5'
  workflow_dispatch:
    description: 'Manually trigger the LinkedIn to HubSpot sync'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create necessary directories
      run: |
        mkdir -p scripts/logs

    - name: Calculate random delay
      id: delay
      if: github.event_name == 'schedule'  # Only calculate delay for scheduled runs
      run: |
        # Calculate random delay between 1-3 minutes (60-180 seconds)
        RANDOM_DELAY=$((60 + RANDOM % 120))
        echo "Random delay: $RANDOM_DELAY seconds"
        echo "delay=$RANDOM_DELAY" >> $GITHUB_OUTPUT

    - name: Random delay
      if: github.event_name == 'schedule'  # Only delay for scheduled runs
      run: |
        echo "Sleeping for ${{ steps.delay.outputs.delay }} seconds..."
        sleep ${{ steps.delay.outputs.delay }}
        
    - name: Pull posts from Google Sheets
      env:
        SERVICE_ACCOUNT_KEY: ${{ secrets.SERVICE_ACCOUNT_KEY }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        cd scripts
        echo "Starting Google Sheets sync..."
        python gs_sql.py
        echo "Google Sheets sync completed"
        
    - name: Scrape LinkedIn posts
      env:
        APIFY_API_KEY: ${{ secrets.APIFY_API_KEY }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        cd scripts
        echo "Starting LinkedIn scraping..."
        python scrape.py
        echo "LinkedIn scraping completed"
        
    - name: Sync with HubSpot
      env:
        APIFY_API_KEY: ${{ secrets.APIFY_API_KEY }}
        HUBSPOT_API_KEY: ${{ secrets.HUBSPOT_API_KEY }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        cd scripts
        echo "Starting HubSpot sync..."
        python sql_hs.py
        echo "HubSpot sync completed"